<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>pdf</title>
  <link rel="stylesheet" href="../node_modules/katex/dist/katex.min.css">
  <link rel="stylesheet" href="css/style-padrao.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/page.css">
  <link rel="stylesheet" href="css/linhasResposta.css">
  <style>
    @page {
      margin: 0;
    }

    @media print {
      body {
        background: none;
        margin: 0;
        box-sizing: border-box;
      }

      .page {
        box-shadow: none;
        margin: 0;
        width: 794px;
        height: 1123px;
        aspect-ratio: 794/1123;
        page-break-after: always;

      }

      .content-container {
        display: flex;
      }

      .page-stage {
        display: none;
      }

      /* Firefox-specific fix */
      @-moz-document url-prefix() {
        .page {
          page-break-after: auto;
          /* Avoids forced blank pages */
          break-after: avoid-page;
          /* Ensures pages don't have an unnecessary blank */
        }

        body {
          zoom: 0.99;
          /* Reduces scale slightly for Firefox */
        }
      }
    }

   
  </style>

</head>

<body>
  <div id="pages-container"></div>
  <script type="module">
    import { LayoutProva } from "./layout-colunas.js";
    import { generateAvalicaoHtml } from "./avaliacao-builder.js";
    import latexParser from "./latexParser.js";

    const DONTSPLIT = "dontsplit";
    
    function createQuestoesTempContainer(avaliacaoHtml) {
      const tempContainer = document.createElement("div");
      tempContainer.className = "page-stage";

      const mainDiv = document.createElement("div");
      mainDiv.innerHTML = avaliacaoHtml;

      tempContainer.appendChild(mainDiv);

      tempContainer.querySelectorAll("p").forEach((p) => (p.style.marginLeft = 0));
      tempContainer
        .querySelectorAll("figure")
        .forEach((figure) => figure.classList.add(DONTSPLIT));
      tempContainer
        .querySelectorAll("table")
        .forEach((table) => table.classList.add(DONTSPLIT));
      tempContainer.querySelectorAll(".adaptive-margin-bottom div").forEach((e) => {
        e.classList.add(DONTSPLIT);
      });

      return tempContainer;
    }

    const pagesContainer = document.getElementById('pages-container');

    function adicionarMarcaDagua(marcaDagua) {
      const styleTag = document.createElement('style');
      styleTag.innerHTML = `
         .marcadagua::before {
          background-image: url('${marcaDagua}') !important;
        }
      `;
      document.head.appendChild(styleTag);
    }

    window.generatePdf = (provaModelo) => {

      let avaliacaoHtml = generateAvalicaoHtml(provaModelo)

      avaliacaoHtml = latexParser(avaliacaoHtml);

      const tempContainer = createQuestoesTempContainer(avaliacaoHtml);
      const { cabecalhoPagina, cabecalho, folhaRosto, paginacao, rodape, rodapeRosto, colunas, marcaDagua } = provaModelo.prova.layout;
      const { folhasRascunho } = provaModelo.prova
      const { rascunho, usuario, numeroCte } = provaModelo


      if (marcaDagua) {
        adicionarMarcaDagua(marcaDagua);
      }

      let rodapeInfo = "";

      if(rascunho) {
        rodapeInfo = `<p style="text-align: left; font-size:12px; margin-top:-15px;">${usuario ?? ''}</p>`;
      } else {
        rodapeInfo = `<p style="text-align: left; font-size:12px; margin-top:-15px;">${numeroCte ?? ''}</p>`;
      }

      const layoutProva = LayoutProva.builder(pagesContainer)
        .fonteTamanho(parseInt(provaModelo.fonteTamanho))
        .folhaDeRosto({
          header: cabecalho,
          content: folhaRosto,
          footer: `<div>${rodapeRosto ?? rodape}</div><div>${rodapeInfo}${paginacao}</div>`
        })
        .marcaDaguaRascunho(rascunho)
        .rascunho(folhasRascunho)
        .pageHeader(cabecalhoPagina)
        .pageFooter(`<div>${rodape}</div><div>${rodapeInfo}${paginacao}</div>`)

      if (colunas === 1) {
        layoutProva.oneColumnLayout(tempContainer)
      } else {
        layoutProva.twoColumnLayout(tempContainer)
      }

    }
  </script>
</body>

</html>